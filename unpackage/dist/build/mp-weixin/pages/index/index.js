"use strict";const e=require("../../common/vendor.js"),s={data:()=>({searchKeyword:"",switchList:[],searchHistory:[],hasSearch:!1,showHistory:!1,isNavigating:!1,isDeleting:!1}),onLoad(){const s=e.index.getStorageSync("searchHistory");s&&(this.searchHistory=JSON.parse(s))},methods:{handleFocus(){this.showHistory=!0},handleBlur(){setTimeout((()=>{this.isDeleting?this.isDeleting=!1:this.showHistory=!1}),200)},async handleSearch(){var s,t,i,o,r,n;const a=this.searchKeyword.trim();if(!a)return void console.log("搜索关键词为空");const c=(null==(s=a.match(/[\u4e00-\u9fa5]/g))?void 0:s.length)||0;if(c<2)return console.log("搜索关键词过短,需要至少2个汉字",{keyword:a,chineseCharCount:c}),void e.index.showToast({title:"请输入至少2个汉字",icon:"none"});this.showHistory=!1,e.index.showLoading({title:"搜索中..."});try{console.log("开始搜索:",a);const s=e.er.database();if(!s)throw new Error("数据库连接失败");console.log("数据库连接成功"),console.log("执行搜索查询...");const c=await s.collection("switches").where({switch_name:new RegExp(a,"i")}).get();console.log("搜索返回数据:",{result:c.result,affectedDocs:null==(t=c.result)?void 0:t.affectedDocs,data:null==(i=c.result)?void 0:i.data,errCode:null==(o=c.result)?void 0:o.errCode,errMsg:null==(r=c.result)?void 0:r.errMsg}),this.switchList=Array.isArray(c.result.data)?c.result.data:[],this.hasSearch=!0,0===this.switchList.length?(console.log("搜索成功但无结果:",a),e.index.showToast({title:"未找到相关轴体",icon:"none"})):(console.log("搜索成功, 找到记录数:",this.switchList.length),this.saveSearchHistory(a))}catch(l){console.error("搜索失败:",{name:l.name,message:l.message,stack:l.stack,detail:l.detail||{},errMsg:l.errMsg,errCode:l.errCode}),this.switchList=[],e.index.showToast({title:`搜索失败: ${l.message||"未知错误"}`,icon:"none"})}finally{e.index.hideLoading(),console.log("搜索完成, 当前状态:",{hasSearch:this.hasSearch,resultCount:(null==(n=this.switchList)?void 0:n.length)||0,keyword:a})}},handleClear(){console.log("清除搜索:",{oldKeyword:this.searchKeyword,oldResultCount:this.switchList.length}),this.searchKeyword="",this.switchList=[],this.hasSearch=!1,this.showHistory=!0,console.log("搜索已清除")},handleHistoryClick(e){this.searchKeyword=e,this.handleSearch()},async handleItemClick(s){if(this.isNavigating)console.log("导航进行中，跳过重复点击");else{this.isNavigating=!0;try{console.log("点击轴体项:",s),console.log("准备跳转到详情页, ID:",s._id),await e.index.navigateTo({url:`/pages/switchInfo/switchInfo?id=${s._id}`,success:async()=>{console.log("跳转成功"),setTimeout((()=>{e.index.$emit("switchData",s),console.log("数据已传递到详情页")}),100)},fail:s=>{console.error("跳转失败:",s),e.index.showToast({title:"跳转失败",icon:"none"})}})}catch(t){console.error("跳转失败:",t),e.index.showToast({title:"跳转失败",icon:"none"})}finally{setTimeout((()=>{this.isNavigating=!1}),500)}}},saveSearchHistory(s){console.log("保存搜索历史:",s);const t=this.searchHistory.indexOf(s);t>-1&&(console.log("关键词已存在,位置:",t),this.searchHistory.splice(t,1)),this.searchHistory.unshift(s),this.searchHistory.length>10&&(console.log("历史记录超过10条,移除最后一条"),this.searchHistory.pop()),e.index.setStorageSync("searchHistory",JSON.stringify(this.searchHistory)),console.log("当前搜索历史:",this.searchHistory)},clearHistory(){e.index.showModal({title:"提示",content:"确定要清空搜索历史吗？",success:s=>{s.confirm&&(this.searchHistory=[],e.index.removeStorageSync("searchHistory"))}})},getSpecText(e){console.log("规格数据:",e);const s=e.actuation_force,t=(s?`触发压力: ${s.toString().toLowerCase().includes("gf")?s:`${s}gf`}`:"")+(e.actuation_travel?` 触发行程: ${e.actuation_travel}`:"");return console.log("规格文本:",t),t||"暂无规格信息"},getPriceText:e=>e.price?`¥${e.price}`:"暂无报价",getThumbImage:e=>Array.isArray(e.preview_images)&&e.preview_images.length>0&&e.preview_images[0].fileID?e.preview_images[0].fileID:"/static/default_switch.webp",deleteHistoryItem(s,t){this.isDeleting=!0,t.stopPropagation(),this.searchHistory.splice(s,1),e.index.setStorageSync("searchHistory",JSON.stringify(this.searchHistory))}}};if(!Array){(e.resolveComponent("uni-search-bar")+e.resolveComponent("uni-icons")+e.resolveComponent("uni-list-item")+e.resolveComponent("uni-list"))()}Math||((()=>"../../uni_modules/uni-search-bar/components/uni-search-bar/uni-search-bar.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../uni_modules/uni-list/components/uni-list/uni-list.js"))();const t=e._export_sfc(s,[["render",function(s,t,i,o,r,n){return e.e({a:e.o(n.handleSearch),b:e.o(n.handleClear),c:e.o(n.handleFocus),d:e.o(n.handleBlur),e:e.o((e=>r.searchKeyword=e)),f:e.p({radius:100,placeholder:"搜索轴体",clearButton:"auto",cancelButton:"none",modelValue:r.searchKeyword}),g:r.showHistory&&r.searchHistory.length>0},r.showHistory&&r.searchHistory.length>0?{h:e.o(n.clearHistory),i:e.p({type:"trash",size:"14",color:"#000000"}),j:e.f(r.searchHistory,((s,t,i)=>({a:e.t(s),b:e.o((e=>n.handleHistoryClick(s)),t),c:e.o((e=>n.deleteHistoryItem(t,e)),t),d:t})))}:{},{k:r.switchList.length>0},r.switchList.length>0?{l:e.f(r.switchList,((s,t,i)=>({a:s._id,b:e.o((e=>n.handleItemClick(s)),s._id),c:"4540c6bf-3-"+i+",4540c6bf-2",d:e.p({clickable:!0,title:s.switch_name,note:n.getSpecText(s),rightText:n.getPriceText(s),border:!0,thumb:n.getThumbImage(s),"thumb-size":"lg"})})))}:(r.hasSearch,{}),{m:r.hasSearch})}]]);wx.createPage(t);
